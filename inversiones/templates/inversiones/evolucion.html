<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Evolución de Portafolios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-4">Evolución de Portafolios</h1>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-body">
      <form class="row gy-2 gx-3 align-items-end" id="filtros">
        <div class="col-lg-2 col-md-3">
          <label class="form-label">Portafolio</label>
          <select id="pf" class="form-select">
            <option value="1">Portafolio 1</option>
            <option value="2">Portafolio 2</option>
          </select>
        </div>
        <div class="col-lg-2 col-md-3">
          <label class="form-label">Fecha inicio</label>
          <input type="date" id="fi" class="form-control" value="2022-02-15">
        </div>
        <div class="col-lg-2 col-md-3">
          <label class="form-label">Fecha fin</label>
          <input type="date" id="ff" class="form-control" value="2023-02-16">
        </div>

        <!-- Selector de activos con checkboxes -->
        <div class="col-lg-3 col-md-6">
          <label class="form-label d-block">Activos</label>
          <div class="dropdown w-100">
            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="dropdownActivosBtn">
              Seleccionar activos
            </button>
            <div class="dropdown-menu p-3" style="max-height: 360px; overflow:auto;" id="dropdownActivos">
              <div class="d-flex gap-2 mb-2">
                <button class="btn btn-sm btn-outline-primary" type="button" id="btnSelTodo">Todo</button>
                <button class="btn btn-sm btn-outline-secondary" type="button" id="btnSelNada">Ninguno</button>
              </div>
              <div id="activosChecks" class="d-grid gap-1"></div>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-3 d-grid">
    <button type="submit" class="btn btn-primary">Actualizar</button>
  </div>
    <div class="col-lg-3 col-md-3 d-grid">
      <a href="/admin/" class="btn btn-outline-secondary">Volver a administración</a>
    </div>
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Weights \(w_{i,t}\) (stacked area)</span>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-success" id="btnCSV">Descargar CSV</button>
            <button class="btn btn-sm btn-outline-dark" id="btnPNGWeights">Exportar PNG</button>
          </div>
        </div>
        <div class="card-body">
          <canvas id="chartWeights" height="120"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Valor del Portafolio \(V_t\)</span>
          <button class="btn btn-sm btn-outline-dark" id="btnPNGVt">Exportar PNG</button>
        </div>
        <div class="card-body">
          <canvas id="chartVt" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const apiBase = '/api/portafolios';

let chartWeights, chartVt;
let rawData = null;            // última respuesta del endpoint
let activosArr = [];           // lista de activos disponibles
let activosSelected = new Set(); // activos seleccionados

function stackedAreaOptions() {
  return {
    responsive: true,
    interaction: { mode: 'index', intersect: false },
    stacked: true,
    plugins: { legend: { position: 'bottom' } },
    scales: {
      x: { stacked: true, ticks: { maxTicksLimit: 10 } },
      y: { stacked: true, min: 0, max: 1, ticks: { callback: v => v.toFixed(1) } }
    }
  };
}

function lineOptions() {
  return {
    responsive: true,
    plugins: { legend: { display: false } },
    scales: {
      x: { ticks: { maxTicksLimit: 6, maxRotation: 45, minRotation: 45 } },
      y: { beginAtZero: false }
    }
  };
}

async function fetchData(pf, fi, ff) {
  const url = `${apiBase}/${pf}/evolucion/?fecha_inicio=${fi}&fecha_fin=${ff}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('Error API');
  return res.json();
}

function ensureSelections() {
  if (activosSelected.size === 0 && activosArr.length > 0) {
    activosArr.forEach(a => activosSelected.add(a)); // por defecto todos
  }
}

function buildAssetSelector() {
  const cont = document.getElementById('activosChecks');
  cont.innerHTML = '';
  activosArr.forEach(a => {
    const id = 'chk_' + a.replace(/\W/g, '_');
    const checked = activosSelected.has(a) ? 'checked' : '';
    cont.insertAdjacentHTML('beforeend', `
      <div class="form-check">
        <input class="form-check-input chk-activo" type="checkbox" value="${a}" id="${id}" ${checked}>
        <label class="form-check-label" for="${id}">${a}</label>
      </div>
    `);
  });

  // eventos
  cont.querySelectorAll('.chk-activo').forEach(chk => {
    chk.addEventListener('change', () => {
      if (chk.checked) activosSelected.add(chk.value);
      else activosSelected.delete(chk.value);
      rebuildWeightsChart(); // actualizar solo gráfico de weights
    });
  });

  document.getElementById('btnSelTodo').onclick = () => {
    activosSelected = new Set(activosArr);
    buildAssetSelector();
    rebuildWeightsChart();
  };
  document.getElementById('btnSelNada').onclick = () => {
    activosSelected = new Set();
    buildAssetSelector();
    rebuildWeightsChart();
  };
}

function datasetsFromWeights(data, activosFilter) {
  const labels = data.Vt.map(d => d.fecha);

  // serie por activo (solo seleccionados)
  const activosSet = new Set(activosFilter);
  const seriesMap = {};
  data.weights.forEach(d => {
    d.w.forEach(w => {
      if (!activosSet.has(w.activo)) return;
      if (!seriesMap[w.activo]) seriesMap[w.activo] = [];
    });
  });

  const activosOrder = Object.keys(seriesMap); // mantener orden de aparición

  activosOrder.forEach(act => seriesMap[act] = Array(labels.length).fill(0));

  // rellenar valores
  data.weights.forEach((d, idx) => {
    d.w.forEach(w => {
      if (seriesMap[w.activo] !== undefined) {
        seriesMap[w.activo][idx] = w.valor ?? 0;
      }
    });
  });

  const datasets = activosOrder.map(act => ({
    label: act,
    data: seriesMap[act],
    fill: true,
    tension: 0.2
  }));

  return { labels, datasets };
}

function rebuildWeightsChart() {
  if (!rawData) return;
  ensureSelections();
  const { labels, datasets } = datasetsFromWeights(rawData, Array.from(activosSelected));
  if (chartWeights) chartWeights.destroy();
  const ctxW = document.getElementById('chartWeights').getContext('2d');
  chartWeights = new Chart(ctxW, {
    type: 'line',
    data: { labels, datasets },
    options: stackedAreaOptions()
  });
}

function buildCharts(data) {
  rawData = data;

  // activos disponibles
  const activos = new Set();
  data.weights.forEach(d => d.w.forEach(w => activos.add(w.activo)));
  activosArr = Array.from(activos);
  if (activosSelected.size === 0) activosArr.forEach(a => activosSelected.add(a));
  buildAssetSelector();

  // weights
  rebuildWeightsChart();

  // Vt
  const labels = data.Vt.map(d => d.fecha);
  const vtValues = data.Vt.map(d => d.valor);
  if (chartVt) chartVt.destroy();
  const ctxV = document.getElementById('chartVt').getContext('2d');
  chartVt = new Chart(ctxV, {
    type: 'line',
    data: { labels, datasets: [{ label: 'Vt', data: vtValues, tension: 0.25 }] },
    options: lineOptions()
  });
}

async function load() {
  const pf = document.getElementById('pf').value;
  const fi = document.getElementById('fi').value;
  const ff = document.getElementById('ff').value;
  const data = await fetchData(pf, fi, ff);
  buildCharts(data);
}

document.getElementById('filtros').addEventListener('submit', async (e) => {
  e.preventDefault();
  await load();
});

// ---- Exportar PNG ----
document.getElementById('btnPNGWeights').addEventListener('click', () => {
  if (!chartWeights) return;
  const a = document.createElement('a');
  a.href = chartWeights.toBase64Image();
  a.download = 'weights.png';
  a.click();
});
document.getElementById('btnPNGVt').addEventListener('click', () => {
  if (!chartVt) return;
  const a = document.createElement('a');
  a.href = chartVt.toBase64Image();
  a.download = 'Vt.png';
  a.click();
});

// ---- Descargar CSV (Vt + weights seleccionados) ----
document.getElementById('btnCSV').addEventListener('click', () => {
  if (!rawData) return;
  const fechas = rawData.Vt.map(d => d.fecha);
  const vtVals = rawData.Vt.map(d => d.valor);

  // columnas: Fecha, Vt, activos seleccionados...
  const activosCols = Array.from(activosSelected);
  const header = ['Fecha', 'Vt', ...activosCols];

  // mapa rápido weights[fecha][activo] = valor
  const wByDate = {};
  rawData.weights.forEach(d => {
    wByDate[d.fecha] = {};
    d.w.forEach(w => { wByDate[d.fecha][w.activo] = w.valor; });
  });

  const rows = [header];
  fechas.forEach((f, idx) => {
    const row = [f, vtVals[idx]];
    activosCols.forEach(a => {
      row.push( (wByDate[f] && wByDate[f][a] != null) ? wByDate[f][a] : 0 );
    });
    rows.push(row);
  });

  const csv = rows.map(r =>
    r.map(x => typeof x === 'string' ? `"${x.replace(/"/g,'""')}"` : x).join(',')
  ).join('\n');

  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'portafolio_series.csv';
  a.click();
  URL.revokeObjectURL(url);
});

// carga inicial
load();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>